<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SeaToSpace | Executive Ops Dashboard</title>
<meta name="description" content="SeaToSpace — Real-time operational intelligence dashboard for maritime, climate, and space operations." />
<style>
  :root{
    --bg:#05070f;
    --panel:rgba(255,255,255,.07);
    --panel2:rgba(255,255,255,.09);
    --border:rgba(255,255,255,.14);
    --text:#eaf0ff;
    --muted:rgba(234,240,255,.65);
    --muted2:rgba(234,240,255,.50);
    --accent:#4fd1ff;
    --accent2:#8b7cff;
    --ok:#22f3b4;
    --warn:#ffca3a;
    --bad:#ff4d6d;
    --shadow: 0 18px 80px rgba(0,0,0,.55);
    --shadow2: 0 10px 30px rgba(0,0,0,.35);
    --r:18px;
    --r2:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--sans);
    color:var(--text);
    background:
      radial-gradient(1000px 600px at 15% 10%, rgba(79,209,255,.16), transparent 60%),
      radial-gradient(1000px 600px at 85% 20%, rgba(139,124,255,.16), transparent 60%),
      radial-gradient(900px 600px at 50% 92%, rgba(34,243,180,.10), transparent 60%),
      linear-gradient(180deg, #05070f, #070b1a 40%, #05070f);
    overflow-x:hidden;
  }

  /* Subtle grid */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:
      linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
    background-size: 88px 88px;
    mask-image: radial-gradient(circle at 50% 20%, black, transparent 72%);
    pointer-events:none;
    opacity:.55;
  }

  /* Noise overlay */
  body::after{
    content:"";
    position:fixed; inset:0;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".9" numOctaves="3" stitchTiles="stitch"/></filter><rect width="240" height="240" filter="url(%23n)" opacity=".12"/></svg>');
    mix-blend-mode: overlay;
    pointer-events:none;
    opacity:.35;
  }

  .wrap{
    max-width: 1200px;
    margin:0 auto;
    padding: 14px 20px 90px;
  }

  /* Glass panels */
  .glass{
    background: linear-gradient(180deg, var(--panel2), var(--panel));
    border:1px solid var(--border);
    border-radius: var(--r);
    box-shadow: var(--shadow2);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }

  /* Top bar */
  header{
    position:sticky; top:0; z-index:50;
    background: rgba(5,7,15,.58);
    border-bottom: 1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 14px 20px;
    max-width:1200px;
    margin:0 auto;
  }

  .brand{
    display:flex; align-items:center; gap:10px;
    min-width: 200px;
  }
  .brand a{
    display:block;
    text-decoration:none;
    color:inherit;
  }
  .brand svg{
    height:36px;
    width:auto;
  }

  .brand b{font-size:14px; letter-spacing:.2px}
  .brand small{display:block; color:var(--muted); font-size:11px; margin-top:2px}

  .search{
    flex:1 1 auto;
    max-width: 520px;
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
  }
  .search input{
    width:100%;
    border:none;
    outline:none;
    background:transparent;
    color: rgba(234,240,255,.85);
    font-size:13px;
  }
  .search input::placeholder{color: rgba(234,240,255,.45)}
  .kbd{
    font-family: var(--mono);
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 10px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(234,240,255,.72);
  }

  .right{
    display:flex; align-items:center; gap:10px;
  }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--muted);
    font-size:12px;
    white-space:nowrap;
  }
  .dot{
    width:8px;height:8px;border-radius:50%;
    background: var(--ok);
    box-shadow: 0 0 0 4px rgba(34,243,180,.12);
  }
  .btn{
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    font-size:13px;
    display:inline-flex; align-items:center; gap:8px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: transform .15s ease, background .2s ease, border-color .2s ease;
  }
  .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.25)}
  .btn.primary{
    background: linear-gradient(135deg, rgba(79,209,255,.22), rgba(139,124,255,.22));
    border-color: rgba(79,209,255,.25);
    box-shadow: 0 18px 60px rgba(79,209,255,.10);
  }

  /* Layout: mobile-first */
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
    margin-top: 14px;
  }

  .panel{
    padding:14px;
  }
  .panel-head{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    margin-bottom:10px;
  }
  .panel-head h2{
    margin:0;
    font-size:13px;
    letter-spacing:.2px;
  }
  .panel-head p{
    margin:4px 0 0;
    font-size:12px;
    color: var(--muted);
    line-height:1.4;
  }

  /* KPI strip */
  .kpis{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px;
  }
  .kpi{
    padding:12px;
    border-radius: var(--r2);
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
  }
  .kpi .label{font-size:11px;color: var(--muted2)}
  .kpi .value{margin-top:6px;font-family:var(--mono);font-size:16px}
  .kpi .sub{margin-top:6px;font-size:11px;color: var(--muted)}
  .sub .ok{color: var(--ok)}
  .sub .warn{color: var(--warn)}
  .sub .bad{color: var(--bad)}

  /* Map panel */
  .map{
    position:relative;
    height: 340px;
    overflow:hidden;
    border-radius: var(--r);
    border:1px solid rgba(255,255,255,.10);
    background:
      radial-gradient(900px 600px at 30% 30%, rgba(79,209,255,.10), transparent 60%),
      radial-gradient(900px 600px at 70% 60%, rgba(139,124,255,.10), transparent 60%),
      rgba(0,0,0,.22);
  }
  .map svg{position:absolute; inset:0; width:100%; height:100%}
  .map .hud{
    position:absolute; left:12px; top:12px;
    display:flex; flex-wrap:wrap; gap:8px;
    z-index:3;
  }
  .pill{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.20);
    font-size:11px;
    color: rgba(234,240,255,.78);
    display:inline-flex; align-items:center; gap:8px;
  }
  .legend{
    position:absolute; right:12px; top:12px;
    z-index:3;
    width: min(240px, 56vw);
  }
  .legend .row{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    margin-bottom:8px;
  }
  .legend .row b{font-size:12px}
  .legend .row small{display:block; margin-top:2px; color: var(--muted); font-size:11px}
  .badge{
    font-family: var(--mono);
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(234,240,255,.78);
    white-space:nowrap;
  }

  /* AIS list / triage */
  .list{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .item{
    padding:12px;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    cursor:pointer;
    transition: transform .15s ease, border-color .2s ease;
  }
  .item:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.20)}
  .item .top{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .item b{font-size:12.5px}
  .item .meta{margin-top:4px; color: var(--muted); font-size:11.5px; line-height:1.35}
  .sev{
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
  }
  .sev.ok{border-color: rgba(34,243,180,.35); background: rgba(34,243,180,.10)}
  .sev.warn{border-color: rgba(255,202,58,.35); background: rgba(255,202,58,.10)}
  .sev.bad{border-color: rgba(255,77,109,.35); background: rgba(255,77,109,.10)}

  /* Graph panel */
  .graphWrap{
    position:relative;
    height: 340px;
    border-radius: var(--r);
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    overflow:hidden;
  }
  #graphCanvas{
    width:100%; height:100%;
    display:block;
  }
  .graphHUD{
    position:absolute; left:12px; bottom:12px;
    display:flex; gap:8px; flex-wrap:wrap;
    z-index:2;
  }
  .seg{
    padding:7px 10px;
    border-radius: 12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.22);
    font-size:11px;
    color: rgba(234,240,255,.78);
    cursor:pointer;
    user-select:none;
  }
  .seg.active{
    border-color: rgba(79,209,255,.35);
    background: rgba(79,209,255,.10);
  }

  /* Insights panel */
  .insight{
    display:flex; flex-direction:column; gap:10px;
  }
  .insight h3{
    margin:0;
    font-size:13px;
  }
  .insight p{
    margin:0;
    font-size:12.5px;
    color: var(--muted);
    line-height:1.55;
  }
  .steps{
    display:flex; flex-direction:column; gap:8px;
  }
  .step{
    display:flex; gap:10px;
    padding:10px 12px;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
  }
  .num{
    width:28px;height:28px;border-radius:12px;
    display:grid; place-items:center;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.18);
    font-family: var(--mono);
    font-size:12px;
    color: rgba(234,240,255,.75);
    flex:0 0 auto;
  }
  .step b{display:block; font-size:12.5px; margin-bottom:2px}
  .step span{display:block; font-size:11.5px; color: var(--muted); line-height:1.45}

  /* Bottom nav (mobile-first exec demo) */
  .bottomNav{
    position:fixed; left:0; right:0; bottom:0;
    z-index:60;
    padding: 10px 12px 14px;
    background: rgba(5,7,15,.70);
    border-top: 1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
  .tabs{
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
  }
  .tab{
    padding:10px 10px;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color: rgba(234,240,255,.78);
    font-size:12px;
    display:flex; align-items:center; justify-content:center; gap:8px;
    cursor:pointer;
    user-select:none;
    transition: transform .15s ease, border-color .2s ease;
  }
  .tab.active{
    border-color: rgba(79,209,255,.30);
    background: linear-gradient(135deg, rgba(79,209,255,.14), rgba(139,124,255,.12));
    color: rgba(234,240,255,.92);
  }
  .tab:active{transform: scale(.98)}
  .ico{
    width:16px;height:16px; display:inline-block;
  }

  /* Desktop layout upgrades */
  @media (min-width: 980px){
    .wrap{padding-bottom: 24px}
    .bottomNav{display:none}
    .grid{
      grid-template-columns: 1.2fr .8fr;
      align-items:stretch;
    }
    .colSpan2{grid-column: 1 / -1;}
    .kpis{grid-template-columns: repeat(4, 1fr)}
    .map, .graphWrap{height: 380px}
  }

  /* Small helpers */
  .hide{display:none !important}
  .muted{color: var(--muted)}

  @media(max-width:600px){
    .brand svg{height:32px}
    .brand svg .subtitle{display:none}
  }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <a href="/">
        <svg viewBox="0 0 180 36" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="SeaToSpace">
          <defs>
            <linearGradient id="stsAccent" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#4fd1ff"/>
              <stop offset="1" stop-color="#8b7cff"/>
            </linearGradient>
          </defs>
          <g transform="translate(0,2)">
            <rect x="0" y="0" width="32" height="32" rx="8"
                  fill="none" stroke="currentColor" stroke-width="1.4" opacity=".7"/>
            <ellipse cx="16" cy="8" rx="10" ry="3"
                     fill="none" stroke="url(#stsAccent)" stroke-width="1.8" opacity=".9"/>
            <ellipse cx="16" cy="8" rx="6" ry="1.8"
                     fill="none" stroke="url(#stsAccent)" stroke-width="1.4" opacity=".6"/>
            <circle cx="16" cy="16" r="2.5" fill="url(#stsAccent)" opacity=".95"/>
            <path d="M 4 24 Q 8 22 12 24 T 20 24 T 28 24"
                  fill="none" stroke="url(#stsAccent)" stroke-width="1.8" 
                  stroke-linecap="round" opacity=".8"/>
            <path d="M 6 28 Q 10 26 14 28 T 22 28 T 26 28"
                  fill="none" stroke="currentColor" stroke-width="1.4" 
                  stroke-linecap="round" opacity=".5"/>
          </g>
          <g transform="translate(42,6)">
            <text x="0" y="16" fill="currentColor"
                  font-size="16" font-weight="600"
                  font-family="system-ui,-apple-system,Segoe UI,Roboto"
                  letter-spacing=".4">SeaToSpace</text>
            <text class="subtitle" x="0" y="30" fill="currentColor" opacity=".55"
                  font-size="10"
                  font-family="system-ui,-apple-system,Segoe UI,Roboto"
                  letter-spacing=".2">
              Operational Intelligence
            </text>
          </g>
        </svg>
      </a>
    </div>

    <div class="search" title="Press / to search">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
        <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <input id="q" placeholder="Search: vessels, zones, anomalies, assets…" />
      <span class="kbd">/</span>
    </div>

    <div class="right">
      <span class="chip" id="opStatus"><span class="dot" id="opDot"></span><span id="opLabel">Nominal</span></span>
      <button class="btn primary" id="btnBrief">
        <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 7h10M7 11h10M7 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 3h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" />
        </svg>
        Export Brief
      </button>
      <button class="btn" id="btnSim">
        <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2v4m0 16v-4M2 12h4m16 0h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 7l3 3M14 14l3 3M17 7l-3 3M10 14l-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Run Sim
      </button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- KPI STRIP -->
  <section class="panel glass">
    <div class="panel-head">
      <div>
        <h2>Operational Pulse</h2>
        <p>Multi-domain fusion summary: maritime + climate + satellite + enterprise.</p>
      </div>
      <span class="chip"><span class="dot" style="background:var(--accent); box-shadow:0 0 0 4px rgba(79,209,255,.12)"></span><span id="clock">—</span></span>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Fused Sources</div>
        <div class="value" id="kSources">—</div>
        <div class="sub"><span class="ok" id="kSourcesD">+—</span> since last sync</div>
      </div>
      <div class="kpi">
        <div class="label">Alerts (24h)</div>
        <div class="value" id="kAlerts">—</div>
        <div class="sub"><span class="warn">watch</span> corridor anomalies</div>
      </div>
      <div class="kpi">
        <div class="label">Forecast Confidence</div>
        <div class="value" id="kConf">—</div>
        <div class="sub"><span class="ok">↑</span> stabilized ensemble</div>
      </div>
      <div class="kpi">
        <div class="label">Decision Latency</div>
        <div class="value" id="kLat">—</div>
        <div class="sub"><span class="bad">hot</span> during surge window</div>
      </div>
    </div>
  </section>

  <!-- MULTI-PANEL GRID -->
  <section class="grid">
    <!-- MAP / AIS MOCK -->
    <div class="panel glass" id="panelMap">
      <div class="panel-head">
        <div>
          <h2>Maritime COP — AIS Mock</h2>
          <p>Zones, corridors, and moving vessels. Tap a vessel to focus & generate narrative.</p>
        </div>
        <span class="chip"><span class="dot" style="background:var(--warn); box-shadow:0 0 0 4px rgba(255,202,58,.12)"></span><span id="corridorState">Corridor: Watch</span></span>
      </div>

      <div class="map" id="map">
        <div class="hud">
          <span class="pill"><span class="dot" style="background:var(--accent); box-shadow:0 0 0 4px rgba(79,209,255,.12)"></span> AIS</span>
          <span class="pill"><span class="dot" style="background:var(--accent2); box-shadow:0 0 0 4px rgba(139,124,255,.12)"></span> SAR</span>
          <span class="pill"><span class="dot" style="background:var(--ok); box-shadow:0 0 0 4px rgba(34,243,180,.12)"></span> Ops</span>
          <span class="pill" id="mapModePill">Mode: Live</span>
        </div>

        <div class="legend">
          <div class="row">
            <div>
              <b id="focusName">Focus: —</b>
              <small id="focusMeta">Tap a vessel / zone</small>
            </div>
            <span class="badge" id="focusId">—</span>
          </div>
          <div class="row">
            <div>
              <b>Risk Score</b>
              <small>evidence-weighted estimate</small>
            </div>
            <span class="badge" id="riskScore">—</span>
          </div>
        </div>

        <!-- SVG map drawn by JS -->
        <svg id="mapSvg" viewBox="0 0 1000 700" preserveAspectRatio="none" aria-label="AIS maritime visualization"></svg>
      </div>
    </div>

    <!-- GRAPH VISUALIZATION -->
    <div class="panel glass" id="panelGraph">
      <div class="panel-head">
        <div>
          <h2>Operational Graph</h2>
          <p>Entities + relationships (vessels, zones, assets, alerts). Drag nodes. Tap node to inspect.</p>
        </div>
        <span class="chip"><span class="dot" style="background:var(--accent2); box-shadow:0 0 0 4px rgba(139,124,255,.12)"></span><span id="graphMode">Graph: Live</span></span>
      </div>

      <div class="graphWrap">
        <canvas id="graphCanvas"></canvas>
        <div class="graphHUD">
          <div class="seg active" data-graph="ops">Ops</div>
          <div class="seg" data-graph="maritime">Maritime</div>
          <div class="seg" data-graph="climate">Climate</div>
          <div class="seg" data-graph="space">Space</div>
        </div>
      </div>
    </div>

    <!-- TRIAGE LIST -->
    <div class="panel glass" id="panelTriage">
      <div class="panel-head">
        <div>
          <h2>Signal Triage</h2>
          <p>Prioritized detections for executive review. Selecting an item updates map + graph focus.</p>
        </div>
        <span class="chip"><span class="dot" style="background:var(--bad); box-shadow:0 0 0 4px rgba(255,77,109,.12)"></span><span id="triageCount">—</span></span>
      </div>

      <div class="list" id="triageList"></div>
    </div>

    <!-- INSIGHTS -->
    <div class="panel glass" id="panelInsight">
      <div class="panel-head">
        <div>
          <h2>Executive Brief</h2>
          <p>Auto-generated narrative: what happened, why it matters, what to do next.</p>
        </div>
        <span class="chip"><span class="dot" id="briefDot"></span><span id="briefLabel">Idle</span></span>
      </div>

      <div class="insight">
        <h3 id="briefTitle">Select a vessel, zone, or triage signal.</h3>
        <p id="briefDesc">This panel turns fused evidence into next actions with provenance-friendly phrasing.</p>

        <div class="steps" id="briefSteps"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px">
          <button class="btn primary" id="btnCopy">Copy Summary</button>
          <button class="btn" id="btnReset">Reset Focus</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Mobile-first bottom tabs -->
<div class="bottomNav">
  <div class="tabs">
    <div class="tab active" data-tab="map">
      <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 6l6-2 6 2 6-2v14l-6 2-6-2-6 2V6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
      Map
    </div>
    <div class="tab" data-tab="graph">
      <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 7h4v4H7V7Zm6 6h4v4h-4v-4ZM13 8l4 4M11 11l2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Graph
    </div>
    <div class="tab" data-tab="triage">
      <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h10M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Triage
    </div>
    <div class="tab" data-tab="brief">
      <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 7h10M7 11h10M7 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 3h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" /></svg>
      Brief
    </div>
  </div>
</div>

<script>
/* =========================
   SeaToSpace Gotham-style Demo
   - Mobile-first panels with bottom tabs
   - AIS maritime visualization (SVG) with moving vessels + zones
   - Graph visualization (Canvas) with draggable nodes
   - Executive brief generator + export/copy
   ========================= */

const $ = (s)=>document.querySelector(s);
const $$ = (s)=>[...document.querySelectorAll(s)];
const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const nowClock = ()=> new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});

const STATE = {
  focus: null, // {type:'vessel'|'zone'|'signal', id, name}
  graphMode: 'ops',
  mapMode: 'live',
  draggingNode: null,
  dragOffset: {x:0,y:0},
  selectedNode: null
};

// ======= Data =======
const ZONES = [
  { id:"ZONE-ALPHA", name:"Zone Alpha", type:"restricted", poly:[[120,140],[360,120],[410,220],[240,280]] },
  { id:"ZONE-BRAVO", name:"Zone Bravo", type:"economic",   poly:[[610,120],[860,140],[830,270],[650,260]] },
  { id:"CORRIDOR-01", name:"Corridor 01", type:"corridor", line:[[220,520],[820,460]] }
];

const VESSELS = [
  { id:"MMSI-533010111", name:"MV KERIS", cls:"cargo", risk:0.34, x:180, y:520, vx:1.1, vy:-0.2 },
  { id:"MMSI-533020222", name:"SV MERANTI", cls:"tanker", risk:0.78, x:420, y:410, vx:0.4, vy:0.6 },
  { id:"MMSI-533030333", name:"FV PELAGIC", cls:"fishing", risk:0.52, x:720, y:520, vx:-0.7, vy:-0.5 },
  { id:"MMSI-533040444", name:"USV-ORION", cls:"usv", risk:0.18, x:640, y:300, vx:0.9, vy:0.1 },
  { id:"MMSI-533050555", name:"RV ASTROLABE", cls:"research", risk:0.41, x:260, y:220, vx:0.3, vy:0.2 },
];

const SIGNALS = [
  {
    id:"SIG-AIS-LOITER",
    sev:"warn",
    title:"AIS loitering pattern near corridor",
    meta:"Maritime • anomaly",
    desc:"Repeated low-speed loops detected near Corridor 01; pattern deviates from historical transit norms.",
    link:{ type:"vessel", id:"MMSI-533020222" },
    steps:[
      ["1","Validate sources","Cross-check AIS with SAR + coastal radar for the time window."],
      ["2","Contextualize","Bind permits, proximity to infrastructure, and weather constraints."],
      ["3","Decide","Escalate to watchlist workflow; request operator confirmation."]
    ]
  },
  {
    id:"SIG-OPS-LATENCY",
    sev:"bad",
    title:"Decision latency spike during surge window",
    meta:"Ops • performance",
    desc:"Alert-to-action time trending upward during peak periods; may violate SLA and safety thresholds.",
    link:{ type:"zone", id:"CORRIDOR-01" },
    steps:[
      ["1","Find bottlenecks","Break down latency by stage, owner, and queue depth."],
      ["2","Automate triage","Suppress noise; route high-confidence alerts to duty officer."],
      ["3","Measure improvement","Track before/after KPIs with audit-safe logs."]
    ]
  },
  {
    id:"SIG-MET-WINDOW",
    sev:"ok",
    title:"Metocean window suitable for offshore operation",
    meta:"Offshore • forecast",
    desc:"Forecast ensemble shows a stable 18-hour window below wave/wind thresholds at the site.",
    link:{ type:"zone", id:"ZONE-BRAVO" },
    steps:[
      ["1","Confirm thresholds","Load operational limits + safety margins for Hs, wind gust, current."],
      ["2","Run scenarios","Test schedule shifts (+/- 6h) and compute downtime risk."],
      ["3","Publish brief","Export ops brief with assumptions and confidence band."]
    ]
  },
  {
    id:"SIG-SAT-TASK",
    sev:"warn",
    title:"Satellite tasking: cloud-avoid collection strategy",
    meta:"Space • collection",
    desc:"Cloud probability rising for target region; recommend multi-pass schedule and alternate sensors.",
    link:{ type:"zone", id:"ZONE-ALPHA" },
    steps:[
      ["1","Fuse forecasts","Combine cloud nowcasts with orbital opportunities."],
      ["2","Optimize passes","Allocate sensor types by expected visibility and mission value."],
      ["3","Track outcomes","Auto-tag captures with quality score and learning feedback."]
    ]
  }
];

// ======= KPI Pulse =======
function updateKPIs(){
  $("#clock").textContent = nowClock();

  const sources = rand(18, 34);
  const d = rand(1, 4);
  const alerts = rand(3, 19);
  const conf = rand(72, 96);
  const lat = rand(180, 740);

  $("#kSources").textContent = String(sources).padStart(2,"0");
  $("#kSourcesD").textContent = `+${d}`;
  $("#kAlerts").textContent = String(alerts).padStart(2,"0");
  $("#kConf").textContent = `${conf}%`;
  $("#kLat").textContent = `${lat} ms`;

  // status
  const sevRoll = Math.random();
  let sev = "ok";
  if(sevRoll > 0.70) sev = "warn";
  if(sevRoll > 0.88) sev = "bad";

  const dot = $("#opDot"), label=$("#opLabel");
  if(sev==="ok"){ dot.style.background="var(--ok)"; dot.style.boxShadow="0 0 0 4px rgba(34,243,180,.12)"; label.textContent="Nominal"; }
  if(sev==="warn"){ dot.style.background="var(--warn)"; dot.style.boxShadow="0 0 0 4px rgba(255,202,58,.12)"; label.textContent="Watch"; }
  if(sev==="bad"){ dot.style.background="var(--bad)"; dot.style.boxShadow="0 0 0 4px rgba(255,77,109,.12)"; label.textContent="Elevated"; }
}
setInterval(updateKPIs, 1500);
updateKPIs();

// ======= Triage List =======
function renderTriage(q=""){
  const query = q.trim().toLowerCase();
  const list = SIGNALS.filter(s => (s.title+" "+s.meta+" "+s.desc+" "+s.id).toLowerCase().includes(query));
  $("#triageCount").textContent = `${list.length} signals`;

  const el = $("#triageList");
  el.innerHTML = "";
  list.forEach(sig=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="top">
        <div>
          <b>${escapeHtml(sig.title)}</b>
          <div class="meta">${escapeHtml(sig.meta)} • ${escapeHtml(sig.id)}</div>
        </div>
        <span class="sev ${sig.sev}">${sig.sev.toUpperCase()}</span>
      </div>
      <div class="meta" style="margin-top:8px">${escapeHtml(sig.desc)}</div>
    `;
    div.addEventListener("click", ()=>{
      focusSignal(sig.id);
      // On mobile, jump to brief tab for exec flow
      if(isMobile()) activateTab("brief");
    });
    el.appendChild(div);
  });
}
renderTriage();

// ======= Search with / =======
$("#q").addEventListener("input", e=>{
  const q = e.target.value;
  renderTriage(q);
});
window.addEventListener("keydown", (e)=>{
  if(e.key === "/" && document.activeElement !== $("#q")){
    e.preventDefault();
    $("#q").focus();
  }
});

// ======= Mobile Tabs (show one panel at a time) =======
function isMobile(){ return window.matchMedia("(max-width: 979px)").matches; }

function activateTab(tab){
  $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
  // panels
  $("#panelMap").classList.toggle("hide", tab!=="map");
  $("#panelGraph").classList.toggle("hide", tab!=="graph");
  $("#panelTriage").classList.toggle("hide", tab!=="triage");
  $("#panelInsight").classList.toggle("hide", tab!=="brief");
}
$$(".tab").forEach(t=>{
  t.addEventListener("click", ()=>activateTab(t.dataset.tab));
});
function syncMobilePanels(){
  if(isMobile()){
    // default map view
    if(!$$(".tab.active").length) activateTab("map");
    // ensure only active is shown
    const active = $$(".tab.active")[0]?.dataset.tab || "map";
    activateTab(active);
  }else{
    // desktop: show all
    $("#panelMap").classList.remove("hide");
    $("#panelGraph").classList.remove("hide");
    $("#panelTriage").classList.remove("hide");
    $("#panelInsight").classList.remove("hide");
  }
}
window.addEventListener("resize", syncMobilePanels);
syncMobilePanels();

// ======= AIS MAP (SVG) =======
const svg = $("#mapSvg");
const MAP_W = 1000, MAP_H = 700;

// Simple "coastline" + bathymetry lines (mock)
function drawBaseMap(){
  svg.innerHTML = "";
  // background gradients
  const defs = el("defs");
  defs.innerHTML = `
    <linearGradient id="seaG" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="rgba(79,209,255,0.08)"/>
      <stop offset="1" stop-color="rgba(139,124,255,0.06)"/>
    </linearGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="2.8" result="b"/>
      <feMerge>
        <feMergeNode in="b"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  `;
  svg.appendChild(defs);

  const bg = rect(0,0,MAP_W,MAP_H, { fill:"url(#seaG)", opacity:"1" });
  svg.appendChild(bg);

  // fake contours
  for(let i=0;i<8;i++){
    const path = el("path", {
      d: `M ${rand(20,120)} ${rand(40,140)} C ${rand(200,380)} ${rand(140,260)}, ${rand(540,740)} ${rand(80,300)}, ${rand(860,980)} ${rand(140,520)}`,
      stroke:"rgba(255,255,255,.06)",
      "stroke-width":"1",
      fill:"none",
      opacity: "0.9"
    });
    svg.appendChild(path);
  }

  // "coastline" blob
  const coast = el("path", {
    d: "M 0 80 C 140 40, 250 120, 340 160 C 460 220, 520 170, 610 220 C 720 280, 790 260, 1000 320 L 1000 0 L 0 0 Z",
    fill: "rgba(255,255,255,.04)",
    stroke: "rgba(255,255,255,.08)",
    "stroke-width":"1"
  });
  svg.appendChild(coast);

  // Zones polygons
  ZONES.forEach(z=>{
    if(z.type==="corridor"){
      const [a,b] = z.line;
      const line = el("line", {
        x1:a[0], y1:a[1], x2:b[0], y2:b[1],
        stroke:"rgba(255,202,58,.50)",
        "stroke-width":"6",
        "stroke-linecap":"round",
        opacity:"0.18"
      });
      const line2 = el("line", {
        x1:a[0], y1:a[1], x2:b[0], y2:b[1],
        stroke:"rgba(255,202,58,.78)",
        "stroke-width":"2",
        "stroke-linecap":"round",
        opacity:"0.70",
        filter:"url(#glow)"
      });
      line.dataset.id = z.id;
      line2.dataset.id = z.id;
      line.addEventListener("click", ()=>focusZone(z.id));
      line2.addEventListener("click", ()=>focusZone(z.id));
      svg.appendChild(line);
      svg.appendChild(line2);

      const midx = (a[0]+b[0])/2, midy=(a[1]+b[1])/2;
      const tag = labelTag(midx, midy-14, z.name, "rgba(255,202,58,.85)");
      tag.dataset.id = z.id;
      tag.addEventListener("click", ()=>focusZone(z.id));
      svg.appendChild(tag);
      return;
    }

    const pts = z.poly.map(p=>p.join(",")).join(" ");
    const poly = el("polygon", {
      points: pts,
      fill: z.type==="restricted" ? "rgba(255,77,109,.10)" : "rgba(34,243,180,.08)",
      stroke: z.type==="restricted" ? "rgba(255,77,109,.35)" : "rgba(34,243,180,.30)",
      "stroke-width":"2"
    });
    poly.dataset.id = z.id;
    poly.style.cursor="pointer";
    poly.addEventListener("click", ()=>focusZone(z.id));
    svg.appendChild(poly);

    // label
    const cx = z.poly.reduce((s,p)=>s+p[0],0)/z.poly.length;
    const cy = z.poly.reduce((s,p)=>s+p[1],0)/z.poly.length;
    const tag = labelTag(cx, cy, z.name, z.type==="restricted" ? "rgba(255,77,109,.85)" : "rgba(34,243,180,.85)");
    tag.dataset.id = z.id;
    tag.addEventListener("click", ()=>focusZone(z.id));
    svg.appendChild(tag);
  });
}

function labelTag(x,y,text,color){
  const g = el("g", {});
  const w = Math.max(90, text.length*7.2);
  const r = el("rect", { x:x - w/2, y:y-12, width:w, height:24, rx:"12", fill:"rgba(0,0,0,.25)", stroke:"rgba(255,255,255,.10)" });
  const t = el("text", { x:x, y:y+5, "text-anchor":"middle", "font-size":"12", fill:color, "font-family":"system-ui" });
  t.textContent = text;
  g.appendChild(r); g.appendChild(t);
  g.style.cursor = "pointer";
  return g;
}

function rect(x,y,w,h,attrs={}){
  return el("rect", {x,y,width:w,height:h,...attrs});
}
function el(name, attrs={}){
  const e = document.createElementNS("http://www.w3.org/2000/svg", name);
  Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k, v));
  return e;
}

// Vessels rendering: each vessel has dot + heading line
function drawVessels(){
  // remove old vessel layers
  $$("#mapSvg .vessel").forEach(n=>n.remove());

  VESSELS.forEach(v=>{
    const g = el("g", { class:"vessel" });

    const ring = el("circle", {
      cx:v.x, cy:v.y, r:"14",
      fill: v.risk>0.7 ? "rgba(255,77,109,.10)" : (v.risk>0.45 ? "rgba(255,202,58,.10)" : "rgba(79,209,255,.10)"),
      stroke: "rgba(255,255,255,.06)",
      "stroke-width":"1"
    });

    const dot = el("circle", {
      cx:v.x, cy:v.y, r:"4.6",
      fill: v.risk>0.7 ? "rgba(255,77,109,.95)" : (v.risk>0.45 ? "rgba(255,202,58,.95)" : "rgba(79,209,255,.95)"),
      filter:"url(#glow)"
    });

    const hx = v.x + v.vx*14;
    const hy = v.y + v.vy*14;
    const head = el("line", {
      x1:v.x, y1:v.y, x2:hx, y2:hy,
      stroke: "rgba(234,240,255,.35)",
      "stroke-width":"2",
      "stroke-linecap":"round",
      opacity:"0.8"
    });

    // name tag near
    const tag = labelTag(v.x+42, v.y-26, v.name, "rgba(234,240,255,.80)");
    tag.setAttribute("class","vessel");
    tag.style.opacity = "0.75";

    g.appendChild(ring);
    g.appendChild(head);
    g.appendChild(dot);

    // interaction
    g.style.cursor = "pointer";
    g.addEventListener("click", ()=>{
      focusVessel(v.id);
      if(isMobile()) activateTab("brief");
    });

    svg.appendChild(g);
    svg.appendChild(tag);
  });

  // highlight focus if vessel
  if(STATE.focus?.type==="vessel"){
    const v = VESSELS.find(x=>x.id===STATE.focus.id);
    if(v){
      const focusRing = el("circle", {
        class:"vessel",
        cx:v.x, cy:v.y, r:"22",
        fill:"none",
        stroke:"rgba(79,209,255,.60)",
        "stroke-width":"2.2",
        opacity:"0.9",
        filter:"url(#glow)"
      });
      svg.appendChild(focusRing);
    }
  }
}

function tickVessels(){
  // move and bounce, add some "loitering" for risky vessel
  VESSELS.forEach(v=>{
    let vx = v.vx, vy = v.vy;

    if(v.risk > 0.7){
      // loiter swirl
      const t = Date.now()/900;
      vx = Math.cos(t)*0.9;
      vy = Math.sin(t)*0.6;
    }

    v.x += vx;
    v.y += vy;

    // bounds
    if(v.x < 60 || v.x > MAP_W-60) v.vx *= -1;
    if(v.y < 80 || v.y > MAP_H-60) v.vy *= -1;

    v.x = clamp(v.x, 40, MAP_W-40);
    v.y = clamp(v.y, 60, MAP_H-40);
  });

  drawVessels();
}

// ======= Graph Visualization (Canvas Force Layout) =======
const canvas = $("#graphCanvas");
const ctx = canvas.getContext("2d");
let G = { nodes:[], edges:[] };

function resizeCanvas(){
  const parent = canvas.parentElement;
  const rect = parent.getBoundingClientRect();
  canvas.width = Math.max(320, Math.floor(rect.width * devicePixelRatio));
  canvas.height = Math.max(260, Math.floor(rect.height * devicePixelRatio));
  canvas.style.width = rect.width + "px";
  canvas.style.height = rect.height + "px";
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resizeCanvas);

function buildGraph(mode="ops"){
  STATE.graphMode = mode;
  $("#graphMode").textContent = `Graph: ${mode[0].toUpperCase()+mode.slice(1)}`;

  // Basic node sets
  const nodes = [];
  const edges = [];

  // anchor nodes
  nodes.push(node("HQ","Ops HQ","core"));
  nodes.push(node("COP","Maritime COP","core"));
  nodes.push(node("SAT","Satellite Tasking","core"));
  nodes.push(node("MET","Metocean Model","core"));

  // vessel nodes
  VESSELS.slice(0,4).forEach(v=>nodes.push(node(v.id, v.name, "vessel", v.risk)));

  // zone nodes
  ZONES.forEach(z=>nodes.push(node(z.id, z.name, "zone")));

  // signal nodes
  SIGNALS.forEach(s=>nodes.push(node(s.id, s.title, "signal", s.sev==="bad"?0.9:(s.sev==="warn"?0.6:0.25))));

  // edges vary by mode
  const link = (a,b,w=1)=>edges.push({a,b,w});

  // Core structure
  link("HQ","COP",1.2); link("HQ","SAT",1.0); link("HQ","MET",1.0);
  link("COP","CORRIDOR-01",1.2);
  link("MET","ZONE-BRAVO",1.0);
  link("SAT","ZONE-ALPHA",1.0);

  // Signals to their links
  SIGNALS.forEach(s=>{
    link(s.id, s.link.id, 1.3);
    link(s.id, "HQ", 0.9);
  });

  // Vessels to COP / corridor
  link("MMSI-533020222","CORRIDOR-01",1.2);
  link("MMSI-533010111","COP",0.9);
  link("MMSI-533030333","COP",0.9);
  link("MMSI-533040444","ZONE-BRAVO",0.9);

  // Mode emphasis: add extra edges
  if(mode==="maritime"){
    link("COP","MMSI-533020222",1.4);
    link("COP","MMSI-533030333",1.1);
    link("COP","ZONE-ALPHA",1.0);
  }else if(mode==="climate"){
    link("MET","SIG-MET-WINDOW",1.3);
    link("MET","ZONE-ALPHA",1.0);
    link("MET","CORRIDOR-01",0.9);
  }else if(mode==="space"){
    link("SAT","SIG-SAT-TASK",1.3);
    link("SAT","ZONE-BRAVO",0.9);
  }else{
    link("HQ","SIG-OPS-LATENCY",1.3);
    link("HQ","SIG-AIS-LOITER",1.0);
  }

  // initial placement
  const w = canvas.clientWidth || 400;
  const h = canvas.clientHeight || 300;
  nodes.forEach((n,i)=>{
    n.x = rand(80, Math.max(200,w-80));
    n.y = rand(80, Math.max(200,h-80));
    n.vx = (Math.random()-0.5)*1.5;
    n.vy = (Math.random()-0.5)*1.5;
  });

  G = { nodes, edges };
  // apply focus if exists
  if(STATE.focus){
    const nid = (STATE.focus.type==="signal") ? STATE.focus.id : STATE.focus.id;
    STATE.selectedNode = G.nodes.find(n=>n.id===nid) || null;
  }
}

function node(id,label,type,risk=0.3){
  return { id, label, type, risk, x:0,y:0,vx:0,vy:0, r: 14 };
}

function colorForNode(n){
  if(n.type==="core") return "rgba(139,124,255,.85)";
  if(n.type==="zone") return "rgba(34,243,180,.80)";
  if(n.type==="vessel"){
    if(n.risk>0.7) return "rgba(255,77,109,.92)";
    if(n.risk>0.45) return "rgba(255,202,58,.92)";
    return "rgba(79,209,255,.92)";
  }
  // signal
  if(n.risk>0.75) return "rgba(255,77,109,.92)";
  if(n.risk>0.45) return "rgba(255,202,58,.92)";
  return "rgba(79,209,255,.80)";
}

function stepGraph(){
  const w = canvas.clientWidth || 400;
  const h = canvas.clientHeight || 300;

  // Physics params
  const rep = 2200;     // repulsion
  const spring = 0.002; // spring
  const damp = 0.92;
  const centerPull = 0.0022;

  // repel
  for(let i=0;i<G.nodes.length;i++){
    const a = G.nodes[i];
    for(let j=i+1;j<G.nodes.length;j++){
      const b = G.nodes[j];
      let dx = a.x-b.x, dy = a.y-b.y;
      let d2 = dx*dx+dy*dy+0.01;
      let f = rep / d2;
      const inv = 1/Math.sqrt(d2);
      dx *= inv; dy *= inv;
      a.vx += dx*f; a.vy += dy*f;
      b.vx -= dx*f; b.vy -= dy*f;
    }
  }

  // springs
  G.edges.forEach(e=>{
    const a = G.nodes.find(n=>n.id===e.a);
    const b = G.nodes.find(n=>n.id===e.b);
    if(!a||!b) return;
    const dx = b.x-a.x, dy=b.y-a.y;
    const dist = Math.sqrt(dx*dx+dy*dy)+0.01;
    const target = 120 / e.w;
    const f = (dist-target) * spring * e.w;
    const nx = dx/dist, ny=dy/dist;
    a.vx += nx*f; a.vy += ny*f;
    b.vx -= nx*f; b.vy -= ny*f;
  });

  // integrate + center pull
  G.nodes.forEach(n=>{
    if(STATE.draggingNode && STATE.draggingNode.id===n.id){
      // dragged node pinned
      n.vx = 0; n.vy = 0;
      return;
    }
    n.vx += (w/2 - n.x) * centerPull;
    n.vy += (h/2 - n.y) * centerPull;

    n.vx *= damp; n.vy *= damp;
    n.x += n.vx; n.y += n.vy;

    n.x = clamp(n.x, 30, w-30);
    n.y = clamp(n.y, 30, h-30);
  });
}

function drawGraph(){
  const w = canvas.clientWidth || 400;
  const h = canvas.clientHeight || 300;
  ctx.clearRect(0,0,w,h);

  // background faint
  ctx.save();
  ctx.globalAlpha = 0.6;
  ctx.strokeStyle = "rgba(255,255,255,.05)";
  for(let x=0;x<w;x+=80){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
  }
  for(let y=0;y<h;y+=80){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }
  ctx.restore();

  // edges
  G.edges.forEach(e=>{
    const a = G.nodes.find(n=>n.id===e.a);
    const b = G.nodes.find(n=>n.id===e.b);
    if(!a||!b) return;
    const isFocus = (STATE.selectedNode && (a.id===STATE.selectedNode.id || b.id===STATE.selectedNode.id));
    ctx.lineWidth = isFocus ? 2.0 : 1.0;
    ctx.strokeStyle = isFocus ? "rgba(79,209,255,.35)" : "rgba(255,255,255,.10)";
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();
  });

  // nodes
  G.nodes.forEach(n=>{
    const c = colorForNode(n);
    const isSel = STATE.selectedNode && STATE.selectedNode.id===n.id;

    // halo
    ctx.beginPath();
    ctx.arc(n.x, n.y, isSel? 18:14, 0, Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.fill();

    ctx.beginPath();
    ctx.arc(n.x, n.y, isSel? 16:12, 0, Math.PI*2);
    ctx.fillStyle = c.replace("0.92","0.18").replace("0.85","0.18").replace("0.80","0.18");
    ctx.fill();

    ctx.beginPath();
    ctx.arc(n.x, n.y, isSel? 5.4:4.6, 0, Math.PI*2);
    ctx.fillStyle = c;
    ctx.fill();

    // label
    ctx.font = "12px system-ui";
    ctx.fillStyle = "rgba(234,240,255,.78)";
    const label = n.label.length>18 ? n.label.slice(0,18)+"…" : n.label;
    ctx.fillText(label, n.x + 12, n.y - 10);

    ctx.font = "11px " + getComputedStyle(document.documentElement).getPropertyValue("--mono");
    ctx.fillStyle = "rgba(234,240,255,.45)";
    ctx.fillText(n.type, n.x + 12, n.y + 6);
  });
}

function graphLoop(){
  stepGraph();
  drawGraph();
  requestAnimationFrame(graphLoop);
}

// Node picking
function graphPick(px,py){
  // px,py are in CSS pixels
  let best = null;
  let bestD = 1e9;
  G.nodes.forEach(n=>{
    const dx = n.x-px, dy=n.y-py;
    const d2 = dx*dx+dy*dy;
    if(d2 < 20*20 && d2 < bestD){
      best = n; bestD = d2;
    }
  });
  return best;
}

canvas.addEventListener("pointerdown", (e)=>{
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left);
  const y = (e.clientY - rect.top);
  const n = graphPick(x,y);
  if(n){
    STATE.selectedNode = n;
    STATE.draggingNode = n;
    STATE.dragOffset.x = n.x - x;
    STATE.dragOffset.y = n.y - y;
    canvas.setPointerCapture(e.pointerId);
    focusFromNode(n);
  }
});
canvas.addEventListener("pointermove", (e)=>{
  if(!STATE.draggingNode) return;
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left);
  const y = (e.clientY - rect.top);
  STATE.draggingNode.x = x + STATE.dragOffset.x;
  STATE.draggingNode.y = y + STATE.dragOffset.y;
});
canvas.addEventListener("pointerup", (e)=>{
  STATE.draggingNode = null;
  try{ canvas.releasePointerCapture(e.pointerId); }catch(_){}
});

// Graph mode segments
$$(".seg").forEach(s=>{
  s.addEventListener("click", ()=>{
    $$(".seg").forEach(x=>x.classList.toggle("active", x===s));
    buildGraph(s.dataset.graph);
  });
});

// ======= Focus + Brief =======
function setBriefState(sev){
  const dot = $("#briefDot");
  const label = $("#briefLabel");
  if(sev==="ok"){ dot.style.background="var(--ok)"; dot.style.boxShadow="0 0 0 4px rgba(34,243,180,.12)"; label.textContent="Nominal"; }
  if(sev==="warn"){ dot.style.background="var(--warn)"; dot.style.boxShadow="0 0 0 4px rgba(255,202,58,.12)"; label.textContent="Watch"; }
  if(sev==="bad"){ dot.style.background="var(--bad)"; dot.style.boxShadow="0 0 0 4px rgba(255,77,109,.12)"; label.textContent="Elevated"; }
  if(sev==="idle"){ dot.style.background="rgba(255,255,255,.35)"; dot.style.boxShadow="0 0 0 4px rgba(255,255,255,.10)"; label.textContent="Idle"; }
}
setBriefState("idle");

function renderBrief(title, desc, sev, steps){
  $("#briefTitle").textContent = title;
  $("#briefDesc").textContent = desc;
  setBriefState(sev);

  const el = $("#briefSteps");
  el.innerHTML = "";
  (steps || []).forEach(([n,t,d])=>{
    const div = document.createElement("div");
    div.className = "step";
    div.innerHTML = `
      <div class="num">${escapeHtml(n)}</div>
      <div>
        <b>${escapeHtml(t)}</b>
        <span>${escapeHtml(d)}</span>
      </div>
    `;
    el.appendChild(div);
  });
}

function focusVessel(id){
  const v = VESSELS.find(x=>x.id===id);
  if(!v) return;
  STATE.focus = { type:"vessel", id:v.id, name:v.name };

  $("#focusName").textContent = `Focus: ${v.name}`;
  $("#focusMeta").textContent = `Vessel • ${v.cls} • risk ${(v.risk).toFixed(2)}`;
  $("#focusId").textContent = v.id;
  $("#riskScore").textContent = `${Math.round(v.risk*100)} / 100`;

  const sev = v.risk>0.7 ? "bad" : (v.risk>0.45 ? "warn" : "ok");

  const desc =
    sev==="bad"
      ? "High-risk vessel behavior detected. Consider immediate validation and escalation to watchlist."
      : sev==="warn"
        ? "Moderate anomaly likelihood. Validate against independent sources and track trend over next hours."
        : "Nominal behavior relative to baseline. Continue monitoring and preserve provenance for audit.";

  const steps = [
    ["1","Verify evidence","Confirm AIS integrity; cross-check with SAR and radar if available."],
    ["2","Assess intent","Compare behavior vs historical cluster and permits; review proximity to infrastructure."],
    ["3","Decide","Assign action owner; set monitoring threshold; document rationale for audit trail."]
  ];

  renderBrief(`${v.name} — Operational Narrative`, desc, sev, steps);

  // also select a graph node
  STATE.selectedNode = G.nodes.find(n=>n.id===v.id) || STATE.selectedNode;

  drawBaseMap();
  drawVessels();
}

function focusZone(id){
  const z = ZONES.find(x=>x.id===id);
  if(!z) return;
  STATE.focus = { type:"zone", id:z.id, name:z.name };

  $("#focusName").textContent = `Focus: ${z.name}`;
  $("#focusMeta").textContent = `Zone • ${z.type}`;
  $("#focusId").textContent = z.id;

  // zone "risk"
  const risk = z.type==="restricted" ? 0.72 : (z.type==="corridor" ? 0.63 : 0.38);
  $("#riskScore").textContent = `${Math.round(risk*100)} / 100`;

  const sev = risk>0.7 ? "bad" : (risk>0.45 ? "warn" : "ok");
  const desc =
    z.type==="corridor"
      ? "Corridor congestion and anomaly density are elevated. Tighten triage routing and validate watchlist items."
      : z.type==="restricted"
        ? "Restricted zone is active. Enforce strict policy gates and increase collection cadence."
        : "Economic zone conditions are stable. Maintain scheduled monitoring and metocean constraints.";

  const steps = [
    ["1","Reconcile context","Bind nearby assets, operators, permits, and weather constraints."],
    ["2","Adjust posture","Tune alert thresholds and notification routing for this zone."],
    ["3","Publish brief","Generate a shareable COP snapshot with redactions by role."]
  ];

  renderBrief(`${z.name} — Executive Brief`, desc, sev, steps);

  STATE.selectedNode = G.nodes.find(n=>n.id===z.id) || STATE.selectedNode;

  drawBaseMap();
  drawVessels();
}

function focusSignal(id){
  const s = SIGNALS.find(x=>x.id===id);
  if(!s) return;
  STATE.focus = { type:"signal", id:s.id, name:s.title };

  $("#focusName").textContent = `Focus: ${s.title}`;
  $("#focusMeta").textContent = `${s.meta}`;
  $("#focusId").textContent = s.id;

  const risk = s.sev==="bad" ? 0.86 : (s.sev==="warn" ? 0.62 : 0.28);
  $("#riskScore").textContent = `${Math.round(risk*100)} / 100`;

  renderBrief(s.title, s.desc, s.sev, s.steps);

  // Move map focus to linked entity
  if(s.link?.type==="vessel") focusVessel(s.link.id);
  else if(s.link?.type==="zone") focusZone(s.link.id);

  // Keep signal selected in graph if exists
  STATE.selectedNode = G.nodes.find(n=>n.id===s.id) || STATE.selectedNode;
}

function focusFromNode(n){
  // If node corresponds to known vessel/zone/signal
  if(VESSELS.some(v=>v.id===n.id)) return focusVessel(n.id);
  if(ZONES.some(z=>z.id===n.id)) return focusZone(n.id);
  if(SIGNALS.some(s=>s.id===n.id)) return focusSignal(n.id);

  // core node: generic brief
  STATE.focus = { type:"core", id:n.id, name:n.label };
  $("#focusName").textContent = `Focus: ${n.label}`;
  $("#focusMeta").textContent = `Core module • ${n.id}`;
  $("#focusId").textContent = n.id;
  $("#riskScore").textContent = "—";

  renderBrief(
    `${n.label} — System Narrative`,
    "This module aggregates multi-source telemetry and routes evidence into decision workflows with governance controls.",
    "ok",
    [
      ["1","Ingest & normalize","Map sources into a consistent schema; score quality and confidence."],
      ["2","Model & reason","Link entities across time; produce explainable alerts and scenarios."],
      ["3","Act & audit","Route actions to owners; preserve provenance for review."]
    ]
  );
}

// ======= Map init loop =======
drawBaseMap();
drawVessels();
setInterval(tickVessels, 90);

// ======= Graph init loop =======
resizeCanvas();
buildGraph("ops");
graphLoop();

// ======= Buttons =======
$("#btnReset").addEventListener("click", ()=>{
  STATE.focus = null;
  $("#focusName").textContent = "Focus: —";
  $("#focusMeta").textContent = "Tap a vessel / zone";
  $("#focusId").textContent = "—";
  $("#riskScore").textContent = "—";
  setBriefState("idle");
  $("#briefTitle").textContent = "Select a vessel, zone, or triage signal.";
  $("#briefDesc").textContent = "This panel turns fused evidence into next actions with provenance-friendly phrasing.";
  $("#briefSteps").innerHTML = "";
  drawBaseMap();
  drawVessels();
});

$("#btnCopy").addEventListener("click", async ()=>{
  const text = getBriefText();
  try{
    await navigator.clipboard.writeText(text);
    toast("Copied", "Executive brief copied to clipboard.");
  }catch{
    toast("Copy blocked", "Clipboard may require HTTPS. Use Export Brief instead.");
  }
});

$("#btnBrief").addEventListener("click", ()=>{
  const text = getBriefText();
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "seatospace-exec-brief.txt";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 600);
  toast("Exported", "Downloaded seatospace-exec-brief.txt");
});

$("#btnSim").addEventListener("click", ()=>{
  // Prototype: slightly perturb risk scores and repaint
  VESSELS.forEach(v=>{
    const drift = (Math.random()-0.5)*0.08;
    v.risk = clamp(v.risk + drift, 0.05, 0.95);
  });
  toast("Simulated", "Applied scenario perturbation to risk estimates.");
  drawBaseMap();
  drawVessels();
  buildGraph(STATE.graphMode);
});

// ======= Corridor state pulse =======
setInterval(()=>{
  const r = Math.random();
  $("#corridorState").textContent = r>0.8 ? "Corridor: Elevated" : (r>0.55 ? "Corridor: Watch" : "Corridor: Nominal");
}, 2500);

// ======= Toast (tiny) =======
let toastTimer=null;
function toast(title,msg){
  // lightweight toast using alert-like pill at bottom right, without extra DOM bloat
  let t = $("#_toast");
  if(!t){
    t = document.createElement("div");
    t.id="_toast";
    t.style.position="fixed";
    t.style.right="14px";
    t.style.bottom= isMobile() ? "86px" : "14px";
    t.style.zIndex="100";
    t.style.width="min(420px, calc(100vw - 28px))";
    t.innerHTML = `
      <div class="glass" style="padding:12px 12px; display:flex; gap:10px; align-items:flex-start; justify-content:space-between;">
        <div style="min-width:0">
          <b id="_toastT" style="font-size:12px"></b>
          <div id="_toastM" style="margin-top:3px; font-size:12px; color:rgba(234,240,255,.72); line-height:1.45"></div>
        </div>
        <button class="btn" id="_toastX" style="padding:6px 10px; border-radius:12px;">✕</button>
      </div>
    `;
    document.body.appendChild(t);
    $("#_toastX").addEventListener("click", ()=>t.remove());
  }
  $("#_toastT").textContent = title;
  $("#_toastM").textContent = msg;
  t.style.display="block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ if(t) t.style.display="none"; }, 2800);
}

// ======= Brief text builder =======
function getBriefText(){
  const title = $("#briefTitle").textContent || "SeaToSpace Executive Brief";
  const desc  = $("#briefDesc").textContent || "";
  const steps = $$("#briefSteps .step").map(s=>{
    const b = s.querySelector("b")?.textContent?.trim() || "";
    const sp = s.querySelector("span")?.textContent?.trim() || "";
    return `- ${b}: ${sp}`;
  }).join("\n");
  const focus = STATE.focus ? `${STATE.focus.type.toUpperCase()} ${STATE.focus.id} — ${STATE.focus.name}` : "No focus selected";
  return `SeaToSpace — Executive Brief\nTime: ${new Date().toISOString()}\nFocus: ${focus}\n\n${title}\n${desc}\n\nNext actions:\n${steps}\n`;
}

// ======= Utility =======
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// ======= Default focus for a good first impression =======
setTimeout(()=>{
  focusSignal("SIG-AIS-LOITER");
}, 400);

// ======= Map mode pill toggle =======
$("#mapModePill").addEventListener("click", ()=>{
  STATE.mapMode = (STATE.mapMode==="live") ? "review" : "live";
  $("#mapModePill").textContent = `Mode: ${STATE.mapMode==="live" ? "Live" : "Review"}`;
  toast("Map mode", STATE.mapMode==="live" ? "Live tracking enabled." : "Review mode enabled.");
});
</script>
<footer style="border-top:1px solid var(--border);margin-top:80px;padding:30px 20px;color:var(--muted);font-size:13px;text-align:center">
  © <span id="year"></span> SeaToSpace · Operational Intelligence Platform
</footer>

<script>
document.getElementById("year").textContent=new Date().getFullYear();
</script>
</body>
</html>
